[include mainsail.cfg]

[mcu nhk]
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_rp2040_4E363334320E4F81-if00
restart_method: command

#[include moonraker_obico_macros.cfg]

# This file contains common pin mappings for the BIGTREETECH Manta M8P
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" "8 MHz crystal"
# and "USB (on PA11/PA12)" or "CAN bus (on PD12/PD13)".

# https://github.com/Klipper3d/klipper/blob/master/config/generic-bigtreetech-manta-m8p-v1.1.cfg

# See docs/Config_Reference.md for a description of parameters.

[mcu CM4]
serial: /tmp/klipper_host_mcu

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_hurakan-if00
#canbus_uuid=5b426f4e5253

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_1BB58B295157355957202020FF102508-if00
x_offset: 40 # update with offset from nozzle on your machine
y_offset: 0 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2

[bed_mesh]
zero_reference_position: 175, 175
#    set this to the middle of your bed
speed: 100
#    movement speed of toolhead during bed mesh
horizontal_move_z: 5
#    height of scanner during bed mesh scan
mesh_min: 25, 25
#    start point of bed mesh [X, Y]
mesh_max: 350, 320
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

## Chamber Lighting - HE1 Connector (24V)
[output_pin daylight]
pin: PA3
pwm: True
cycle_time: 0.01

[force_move]
enable_force_move: True

[printer]
kinematics: corexy
max_velocity: 300
max_accel: 4000             #Max 4000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

[stepper_x] # B M1
step_pin: PC8
dir_pin: PC9
enable_pin: !PA15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200  #set to 200 for 1.8 degree stepper
endstop_pin: nhk:gpio13
position_endstop: 377
position_max: 387
homing_speed: 50
homing_retract_dist: 0

[tmc2209 stepper_x]
uart_pin: PD9
interpolate: False
run_current: 1.0
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PD3
driver_SGTHRS: 45
driver_TBL: 2
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 0

[stepper_y] # A M2
step_pin: PA10
dir_pin: PA14                                                        # Check motor direction in link above. If inverted, add a ! before PB2
enable_pin: !PA13
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200  #set to 200 for 1.8 degree stepper
#endstop_pin: tmc2209_stepper_y:virtual_endstop
endstop_pin: PD2
position_endstop: 370
position_max: 385
homing_speed: 50
homing_retract_dist: 10

[tmc2209 stepper_y]
uart_pin: PD8
interpolate: False
run_current: 1.0
sense_resistor: 0.110
stealthchop_threshold: 999999
#diag_pin: ^PD2
#driver_SGTHRS: 45
#driver_TBL: 2
#driver_TOFF: 3
#driver_HSTRT: 3
#driver_HEND: 0

[stepper_z] # M3 Left
step_pin: PC6
dir_pin: PC7
enable_pin: !PA9
microsteps: 16
rotation_distance: 2
full_steps_per_rotation: 200  #set to 200 for 1.8 degree stepper
endstop_pin: probe:z_virtual_endstop
position_max: 350
position_min: -50
homing_speed: 5
second_homing_speed: 3
homing_retract_dist: 0 # beacon needs this to be set to 0

[tmc2209 stepper_z]
uart_pin: PB10
##diag_pin: PF5
run_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 999999

[stepper_z1] # M4 Center
step_pin: PB12
dir_pin: PB11
enable_pin: !PA8
microsteps: 16
rotation_distance: 2
full_steps_per_rotation: 200  #set to 200 for 1.8 degree stepper

[tmc2209 stepper_z1]
uart_pin: PB2
##diag_pin: PC0
run_current: 0.7
sense_resistor: 0.110
interpolate: False
stealthchop_threshold: 999999

[stepper_z2] # M6 Right
step_pin: PB0
dir_pin: PB1
enable_pin: !PC4
microsteps: 16
rotation_distance: 2
full_steps_per_rotation: 200  #set to 200 for 1.8 degree stepper

[tmc2209 stepper_z2]
uart_pin: PA6
run_current: 0.7
sense_resistor: 0.110
interpolate: False
stealthchop_threshold: 999999

##--------------------------------------------------------------------
#####################################################################
#   Extruder
#####################################################################
[extruder]
step_pin: nhk:gpio23
dir_pin: !nhk:gpio24
enable_pin: !nhk:gpio25
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 4.565 #4.52
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: nhk:gpio9
sensor_type: Generic 3950
sensor_pin: nhk:gpio29
pullup_resistor: 2200
#control: pid                                                        # Do PID calibration after initial checks
#pid_Kp: 28.182
#pid_Ki: 1.978
#pid_Kd: 100.397
min_temp: 0
max_temp: 315
min_extrude_temp: 170
max_extrude_only_distance: 1000                                     
max_extrude_cross_section: 30                                       
pressure_advance: 0.052                                             #Be sure to calibrate
pressure_advance_smooth_time: 0.040

[tmc2209 extruder]
sense_resistor: 0.100
uart_pin: nhk:gpio0
tx_pin: nhk:gpio1
interpolate: false
run_current: 0.45                        #.45 minimum offers 12N of force. DO NOT EXCEED .55A as it will cause excess heat.

#####################################################################
#   Fans
#####################################################################
## PCF
[fan]
pin: nhk:gpio6
kick_start_time: .3
off_below: 0.1

## HEF
[heater_fan hotend_fan]
pin: nhk:gpio5
tachometer_pin: nhk:gpio16
tachometer_ppr: 2
max_power: 1.0
kick_start_time: .1
heater: extruder
heater_temp: 50.0
fan_speed: .6


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
##	SSR Pin - BED_OUT
heater_pin: PA5
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA0
##	Adjust Max Power so your heater doesn't warp your bed
#control: pid
min_temp: 0
max_temp: 120
max_power: 0.7
min_temp: 0
max_temp: 120
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769


# See the sample-lcd.cfg file for definitions of common LCD displays.

#####################################################################
#   Probe
#####################################################################

[safe_z_home]
home_xy_position: 185,185
speed: 50
z_hop: 10  # Move up 10mm
z_hop_speed: 5

[z_tilt]
z_positions:  # Bed attachment points (pivot locations for Z motors) - front-right, front-left, back-middle
    366,4    # [stepper_z] = front-right
    17,4     # [stepper_z1] = front-left
    185,357  # [stepper_z2] = back-middle
points:  # Nozzle positions for probing near attachments (probe lands close, X: 0-377, Y: 0-345, probe Y≤385)
    366,50   # Probe at ~366,90 (near front-right 366,4, ~86mm away)
    17,50    # Probe at ~17,90 (near front-left 17,4, ~86mm away)
    185,315  # Probe at ~185,365 (near back-middle 185,357, ~8mm away)
speed: 200
horizontal_move_z: 5
retries: 10
retry_tolerance: 0.03

[screws_tilt_adjust]
screw1: 0,50
screw1_name: front_left  # Probe at ~0,90 (near -14,-46, ~100mm away)
screw2: 377,50
screw2_name: front_right  # Probe at ~377,90 (near 397,-46, ~100mm away)
screw3: 185,315
screw3_name: back_middle  # Probe at ~185,365 (near 185,472, ~107mm away)
speed: 20
horizontal_move_z: 5
screw_thread: CW-M5  # Adjust if your screw thread differs

[bed_screws]
screw1: 0,0    # Closest to front-left screw (-14,-46)
screw2: 377,0  # Closest to front-right screw (397,-46)
screw3: 185,377  # Closest to back-middle screw (185,472)

[gcode_macro Z_TILT_ADJUST_SLOW]
gcode:
    {% set original_velocity = printer.configfile.settings.printer.max_z_velocity|float %}
    {% set original_accel = printer.configfile.settings.printer.max_z_accel|float %}
    SET_VELOCITY_LIMIT VELOCITY=5 ACCEL=100  # Slow Z moves to 5mm/s, 100mm/s²
    Z_TILT_ADJUST
    SET_VELOCITY_LIMIT VELOCITY={original_velocity} ACCEL={original_accel}  # Restore original limits

#####################################################################
#   PInput Shaping
#####################################################################
[adxl345]
cs_pin: nhk:gpio27
spi_software_sclk_pin: nhk:gpio18
spi_software_mosi_pin: nhk:gpio20
spi_software_miso_pin: nhk:gpio19
axes_map: z,-y,x


#####################################################################
#   Macros
#####################################################################

# All customizations are documented in globals.cfg. Just copy a variable from
# there into the section below, and change the value to meet your needs.

[delayed_gcode set_startup_lights]
    initial_duration: 1
    gcode:
        SET_PIN PIN=daylight VALUE=1.00

[gcode_macro M600]
gcode:
    {% set X = params.X|default(50)|float %}
    {% set Y = params.Y|default(0)|float %}
    {% set Z = params.Z|default(10)|float %}
    SAVE_GCODE_STATE NAME=M600_state
    SET_IDLE_TIMEOUT TIMEOUT=8000
    PAUSE
    G91
    G1 E-.8 F2700
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F3000
    G91
    G1 E-50 F1000
    RESTORE_GCODE_STATE NAME=M600_state

[gcode_macro DISABLE_STEPPERS]
gcode:  
    M84

[gcode_macro CHANGE_FILAMENT]
gcode:
    G0 X100 Y0 Z100

[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} Z30  

[gcode_macro PRINT_START]
gcode:
  # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  SET_GCODE_OFFSET Z=0                                 # Set offset to 0

  # Home the printer, set absolute positioning and update the Stealthburner LEDs.
  STATUS_HOMING                                         # Set LEDs to homing-mode
  G28                                                   # Full home (XYZ)
  G90                                                   # Absolute position

  ##  Uncomment for bed mesh (1 of 2 for bed mesh)
  BED_MESH_CLEAR                                       # Clear old saved bed mesh (if any)

  # Heat hotend to 150c. This helps with getting a correct Z-home.
  SET_DISPLAY_TEXT MSG="Hotend: 150c"                   # Display info on display
  M109 S150                                             # Heat hotend to 150c

  ##  Uncomment for Trident (Z_TILT_ADJUST)
  SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
  STATUS_LEVELING                                      # Set LEDs to leveling-mode
  Z_TILT_ADJUST                                        # Level the printer via Z_TILT_ADJUST
  G28 Z                                                # Home Z again after Z_TILT_ADJUST

  ##  Uncomment for bed mesh (2 of 2 for bed mesh)
  SET_DISPLAY_TEXT MSG="Bed mesh"                      # Display info on display
  STATUS_MESHING                                       # Set LEDs to bed mesh-mode
  BED_MESH_CALIBRATE                                   # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh

  # Heat up the hotend up to target via data from slicer
  SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"     # Display info on display
  STATUS_HEATING                                        # Set LEDs to heating-mode
  G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
  M107                                                  # Turn off partcooling fan
  M109 S{target_extruder}                               # Heat the hotend to set temp

  # Get ready to print by doing a primeline and updating the LEDs
  SET_DISPLAY_TEXT MSG="Printer goes brr"               # Display info on display
  DAYLIGHT_ON
  STATUS_PRINTING                                       # Set LEDs to printing-mode
  G0 X{x_wait - 50} Y4 F10000                           # Go to starting point
  G0 Z0.4                                               # Raise Z to 0.4
  G91                                                   # Incremental positioning 
  VORON_PURGE
  G90                                                   # Absolute position

##------------------------------------------------------------------------------------------##
################################ END PRINT ###################################################
##------------------------------------------------------------------------------------------##

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
     
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    #SET_DISPLAY_TEXT MSG="NEVERMORE SHUT DOWN"          # Displays info
    #SET_FAN_SPEED FAN=BedFans SPEED=0                     # Turns OFF the nevermore
    SET_DISPLAY_TEXT MSG="JOB 100% COMPLETE"          # Displays info
    #status_off
    #DAYLIGHT_OFF
    SET_IDLE_TIMEOUT TIMEOUT=60
    DISABLE_STEPPERS
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END


[gcode_macro LOAD_FILAMENT]
gcode:
   M83                            ; set extruder to relative
   G1 E70 F300                    ; load
   G1 E22 F150                    ; prime nozzle with filament
   M82                            ; set extruder to absolute
    
[gcode_macro UNLOAD_FILAMENT]
gcode:
   M83                            ; set extruder to relative
   G1 E10 F300                    ; extrude a little to soften tip
   G1 E-40 F300                    ; extrude a little to soften tip
   G1 E-60 F1800                  ; retract some, but not too much or it will jam
   M82                            ; set extruder to absolute


[pause_resume]

[respond]

[virtual_sdcard]
path: ~/printer_data/gcodes # UPDATE THIS FOR YOUR PATH!!!
on_error_gcode: CANCEL_PRINT

[display_status]

[exclude_object]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.233
#*# pid_ki = 2.758
#*# pid_kd = 57.722
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 45.827
#*# pid_ki = 2.050
#*# pid_kd = 256.056
#*#
#*# [beacon model default]
#*# model_coef = 1.311625280090947,
#*# 	1.667404794148402,
#*# 	0.6661899344497705,
#*# 	-0.05076381196444278,
#*# 	0.8214901274091015,
#*# 	2.0321856158354534,
#*# 	-0.5938943316807291,
#*# 	-2.3407425522235745,
#*# 	0.39279635271236196,
#*# 	1.0940009348509476
#*# model_domain = 1.679965150942706e-07,1.9208479052023673e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 23.083492
#*# model_offset = 0.00000
